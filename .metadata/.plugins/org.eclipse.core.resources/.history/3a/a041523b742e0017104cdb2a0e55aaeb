System gameStep0

Event buttonEvent:buttonEvent(X)
Event controlEvent:controlEvent(X)
Dispatch controlMessage:controlMessage(X)

Context ctxButton ip [host="localhost" port=8010]  -g cyan
Context ctxControl ip [host="localhost" port=8020] -g green
Context ctxLed ip [host="localhost" port=8030] -g yellow

QActor mycontrol context ctxControl {
	
	Plan init normal
		println (mycontrol(starts));
		switchToPlan work
		
	Plan work
 		sense time(60000) buttonEvent -> continue;
 		printCurrentEvent;
 		onEvent buttonEvent:buttonEvent(X) -> switchToPlan game;
 		repeatPlan
 		
 	Plan game
 		forward flashled -m controlMessage : controlMessage(1);
 		
	
}

QActor mybutton context ctxButton {
	
	Plan init normal
		println(qabutton(starts));
 		switchToPlan sysOnPc;
// 		switchToPlan sysOnRasp;
  		delay time(60000);
 		println(qabutton(ends))
 	
 	Plan sysOnPc
 		actorOp createGuiButton(24, "button1");
		resumeLastPlan
		
	Plan sysOnRasp
		actorOp createPi4jButton( 24 , "button1");
		resumeLastPlan
		
}

QActor flashled context ctxLed{
	
	Plan init  normal      
		println("flashled(starts)");
		switchToPlan sysWithGuiOnPc;
//		switchToPlan sysOnRasp;
		switchToPlan preGame;
		switchToPlan game;		
 		delay time(60000);
 		println("flashled(ends)")
 		
	Plan sysWithGuiOnPc
		actorOp createGuiLed( 25 ) 	;
		resumeLastPlan     

	Plan sysOnRasp
		actorOp createPi4jLed( 25 ) ;
		resumeLastPlan
		
	Plan preGame
		receiveMsg time (500);
		printCurrentMessage;
		onMsg controlMessage:controlMessage(X) -> resumeLastPlan;
		actorOp switchLedState;
		repeatPlan
		
	Plan game
		receiveMsg time(60000);
		printCurrentMessage;
		onMsg controlMessage:controlMessage("error") -> resumeLastPlan;
//considering the fact that the message is not an error and that the game is not longer than 60 seconds
//reaching this point assure that we received the correct message, so that we can avoid to use another plan
		actorOp turnOn;
		delay time(250);
		actorOp turnOff;
		onMsg controlMessage:controlMessage("ok") -> repeatPlan;
		resumeLastPlan
	
}

QActor myled context ctxLed {

	Plan init normal          
  		println(qaled(starts));
  		switchToPlan sysOnPc;
  		//switchToPlan sysOnRasp;
  		switchToPlan work;
  		delay time(60000);
 		println(qaled(ends))
 		
 	Plan sysOnPc
 		actorOp createGuiLed(25);
		resumeLastPlan
	
	Plan sysOnRasp
		actorOp createPi4jLed(25);
		resumeLastPlan
		
 	Plan work
 		sense time(60000) buttonEvent -> continue;
 		printCurrentEvent;
 		onEvent buttonEvent:buttonEvent(X) -> actorOp switchLedState;
 		repeatPlan
}